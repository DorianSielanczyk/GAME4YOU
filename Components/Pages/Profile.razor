@page "/profile"
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@using System.IdentityModel.Tokens.Jwt

<link href="Profile.css" rel="stylesheet" />

<div class="navbar-profile">
    <NavLink href="/" style="text-decoration: none;">
        <span class="game-text">
            <span class="game">GAME</span>4YOU
        </span>
    </NavLink>

    <span class="user-panel-text">Panel użytkownika</span>

    <div class="nav-icons-profile">
        <div class="profile-container-profile">
            <NavLink href="/profile" style="text-decoration: none; color: white;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="icon-profile">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
            </NavLink>
        </div>

        <NavLink href="/cart" style="text-decoration: none; color: white;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon-cart">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
            </svg>
        </NavLink>
    </div>
</div>

<div class="profile-page-container">
    <div class="sidebar-profile">
        <ul>
            <li><NavLink href="/profile/account">Moje konto</NavLink></li>
            <li><NavLink href="/profile/orders">Zamówienia</NavLink></li>
            <li><NavLink href="/profile/settings">Sprzedaż</NavLink></li>
        </ul>
    </div>

    <div class="content-profile">
        <h2>Witaj w profilu!</h2>
        <p>Wybierz opcję z menu, aby zarządzać swoim kontem.</p>
    </div>
</div>

@code {
    private bool _hasCheckedToken = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasCheckedToken)
        {
            _hasCheckedToken = true;
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");

            if (string.IsNullOrWhiteSpace(token))
            {
                Navigation.NavigateTo("/", true);
                return;
            }

            try
            {
                var handler = new JwtSecurityTokenHandler();
                var jwtToken = handler.ReadJwtToken(token);

                if (jwtToken.ValidTo < DateTime.UtcNow)
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"Upłynął czas, zostajesz wylogowany!");
                    Navigation.NavigateTo("/", true);
                    return;
                }
            }
            catch
            {
                Navigation.NavigateTo("/", true);
            }
        }
    }
}
